"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var https = require("https");

var http = require("http");

var request = require("request");

var querystring = require("querystring");

class HttpClient {
  constructor(options, credentials) {
    this.credentials = credentials;
    this.host = options.host || "rest.nexmo.com";
    this.port = options.port || 443;
    this.https = options.https || https;
    this.http = options.http || http;
    this.headers = {
      "Content-Type": "application/x-www-form-urlencoded",
      Accept: "application/json"
    };
    this.logger = options.logger;
    this.timeout = options.timeout;
    this.requestLib = request;

    if (options.userAgent) {
      this.headers["User-Agent"] = options.userAgent;
    }
  }

  request(endpoint, method, callback) {
    var skipJsonParsing = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
    var customResponseParser = arguments.length > 4 ? arguments[4] : undefined;

    if (typeof method === "function") {
      callback = method;
      endpoint.method = endpoint.method || "GET";
    } else if (typeof method !== "undefined") {
      endpoint.method = method;
    }

    if (endpoint.method === "POST" || endpoint.method === "DELETE") {// TODO: verify the following fix is required
      // Fix broken due ot 411 Content-Length error now sent by Vonage API
      // PL 2016-Sept-6 - commented out Content-Length 0
      // headers['Content-Length'] = 0;
    }

    var options = {
      host: endpoint.host ? endpoint.host : this.host,
      port: this.port,
      path: endpoint.path,
      method: endpoint.method,
      headers: Object.assign({}, this.headers)
    };

    if (this.timeout !== undefined) {
      options.timeout = this.timeout;
    } // Allow existing headers to be overridden
    // Allow new headers to be added


    if (endpoint.headers) {
      Object.keys(endpoint.headers).forEach(function (key) {
        options.headers[key] = endpoint.headers[key];
      });
    }

    if (this.credentials.signatureSecret && this.credentials.signatureMethod) {
      var splitPath = options.path.split(/\?(.+)/);
      var path = splitPath[0];
      var params = querystring.decode(splitPath[1]); // add timestamp if not already present

      if (!params.timestamp) {
        params.timestamp = new Date().getTime() / 1000 | 0; // floor to seconds

        params.timestamp = params.timestamp.toString();
      } // strip API Secret


      delete params.api_secret;
      var hash = this.credentials.generateSignature(params);
      var query = ""; // rebuild query

      Object.keys(params).sort().forEach(key => {
        query += "&" + key + "=" + encodeURI(params[key]);
      }); // replace the first & with ?

      query = query.replace(/&/i, "?");
      options.path = "".concat(path).concat(query, "&sig=").concat(hash);
    }

    this.logger.info("Request:", options, "\nBody:", endpoint.body);
    var request;

    if (options.port === 443) {
      request = this.https.request(options);
    } else {
      request = this.http.request(options);
    }

    request.end(endpoint.body); // Keep an array of String or Buffers,
    // depending on content type (binary or JSON) of response

    var responseData = [];
    request.on("response", response => {
      var isBinary = response.headers["content-type"] === "application/octet-stream";

      if (!isBinary) {
        response.setEncoding("utf8");
      }

      response.on("data", chunk => {
        responseData.push(chunk);
      });
      response.on("end", () => {
        this.logger.info("response ended:", response.statusCode);

        if (callback) {
          if (isBinary) {
            responseData = Buffer.concat(responseData);
          }

          this.__parseResponse(response, responseData, endpoint.method, callback, skipJsonParsing, customResponseParser);
        }
      });
      response.on("close", e => {
        if (e) {
          this.logger.error("problem with API request detailed stacktrace below ");
          this.logger.error(e);
          callback(e);
        }
      });
    });
    request.on("error", e => {
      this.logger.error("problem with API request detailed stacktrace below ");
      this.logger.error(e);
      callback(e);
    });
  }

  __parseResponse(httpResponse, data, method, callback, skipJsonParsing, customResponseParser) {
    var isArrayOrBuffer = data instanceof Array || data instanceof Buffer;

    if (!isArrayOrBuffer) {
      throw new Error("data should be of type Array or Buffer");
    }

    var status = httpResponse.statusCode;
    var headers = httpResponse.headers;
    var response = null;
    var error = null;

    try {
      if (status >= 500) {
        error = {
          message: "Server Error",
          statusCode: status
        };
      } else if (httpResponse.headers["content-type"] === "application/octet-stream") {
        response = data;
      } else if (status === 429) {
        // 429 does not return a parsable body
        if (!headers["retry-after"]) {
          // retry based on allowed per second
          var retryAfterMillis = method === "POST" ? 1000 / 2 : 1000 / 5;
          headers["retry-after"] = retryAfterMillis;
        }

        error = {
          body: data.join("")
        };
      } else if (status === 204) {
        response = null;
      } else if (status >= 400 || status < 200) {
        error = {
          body: JSON.parse(data.join("")),
          headers
        };
      } else if (method !== "DELETE") {
        if (!!skipJsonParsing) {
          response = data.join("");
        } else {
          response = JSON.parse(data.join(""));
        }
      } else {
        response = data;
      }
    } catch (parseError) {
      this.logger.error(parseError);
      this.logger.error("could not convert API response to JSON, above error is ignored and raw API response is returned to client");
      this.logger.error("Raw Error message from API ");
      this.logger.error("\"".concat(data, "\""));
      error = {
        status: status,
        message: "The API response could not be parsed.",
        body: data.join(""),
        parseError: parseError
      };
    }

    if (error) {
      error.statusCode = status;
      error.headers = headers;
    }

    if (typeof callback === "function") {
      if (typeof customResponseParser === "function") {
        // don't try to parse the response on errors
        if (response) {
          response = customResponseParser(response);
        }
      }

      callback(error, response);
    }
  }

  _addLimitedAccessMessageToErrors(callback, limitedAccessStatus) {
    return function (err, data) {
      if (err && err.status == limitedAccessStatus) {
        err._INFO_ = "This endpoint may need activating on your account. Please email support@nexmo.com for more information";
      }

      return callback(err, data);
    };
  }

  get(path, params, callback) {
    var useJwt = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
    var useBasicAuth = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;

    if (!callback) {
      if (typeof params == "function") {
        callback = params;
        params = {};
      }
    }

    params = params || {};

    if (!useJwt && !useBasicAuth) {
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;
    }

    path = path + "?" + querystring.stringify(params);
    var headers = {
      "Content-Type": "application/json"
    };

    if (useJwt) {
      headers["Authorization"] = "Bearer ".concat(this.credentials.generateJwt());
    }

    if (useBasicAuth) {
      headers["Authorization"] = "Basic ".concat(Buffer.from(this.credentials.apiKey + ":" + this.credentials.apiSecret).toString("base64"));
    }

    this.request({
      path: path,
      headers
    }, "GET", callback);
  }

  delete(path, callback, useJwt, useBasicAuth) {
    var params = {};

    if (!useJwt && !useBasicAuth) {
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;
    }

    var headers = {};

    if (useBasicAuth) {
      headers["Authorization"] = "Basic ".concat(Buffer.from(this.credentials.apiKey + ":" + this.credentials.apiSecret).toString("base64"));
    }

    path = path + "?" + querystring.stringify(params);
    this.request({
      path: path,
      headers
    }, "DELETE", callback);
  }

  postFile(path, options, callback, useJwt) {
    var qs = {};

    if (!useJwt) {
      qs["api_key"] = this.credentials.apiKey;
      qs["api_secret"] = this.credentials.apiSecret;
    }

    if (Object.keys(qs).length) {
      var joinChar = "?";

      if (path.indexOf(joinChar) !== -1) {
        joinChar = "&";
      }

      path = path + joinChar + querystring.stringify(qs);
    }

    var file = options.file;
    delete options.file; // We don't send this as metadata

    var formData = {};

    if (file) {
      formData["filedata"] = {
        value: file,
        options: {
          filename: options.filename || null
        }
      };
    }

    if (options.info) {
      formData.info = JSON.stringify(options.info);
    }

    if (options.url) {
      formData.url = options.url;
    }

    this.requestLib.post({
      url: "https://" + this.host + path,
      formData: formData,
      headers: {
        Authorization: "Bearer ".concat(this.credentials.generateJwt())
      }
    }, callback);
  }

  post(path, params, callback, useJwt) {
    var qs = {};

    if (!useJwt) {
      qs["api_key"] = this.credentials.apiKey;
      qs["api_secret"] = this.credentials.apiSecret;
    }

    var joinChar = "?";

    if (path.indexOf(joinChar) !== -1) {
      joinChar = "&";
    }

    path = path + joinChar + querystring.stringify(qs);
    this.request({
      path: path,
      body: querystring.stringify(params)
    }, "POST", callback);
  }

  postJson(path, params, callback, useJwt, useBasicAuth) {
    var qs = {};

    if (!useJwt && !useBasicAuth) {
      qs["api_key"] = this.credentials.apiKey;
      qs["api_secret"] = this.credentials.apiSecret;
    }

    var joinChar = "?";

    if (path.indexOf(joinChar) !== -1) {
      joinChar = "&";
    }

    path = path + joinChar + querystring.stringify(qs);
    var headers = {
      "Content-Type": "application/json"
    };

    if (useBasicAuth) {
      headers["Authorization"] = "Basic ".concat(Buffer.from(this.credentials.apiKey + ":" + this.credentials.apiSecret).toString("base64"));
    }

    this.request({
      path: path,
      body: JSON.stringify(params),
      headers
    }, "POST", callback);
  }

  postUseQueryString(path, params, callback, useJwt) {
    params = params || {};

    if (!useJwt) {
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;
    }

    path = path + "?" + querystring.stringify(params);
    this.request({
      path: path
    }, "POST", callback);
  }

}

var _default = HttpClient;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9IdHRwQ2xpZW50LmpzIl0sIm5hbWVzIjpbImh0dHBzIiwicmVxdWlyZSIsImh0dHAiLCJyZXF1ZXN0IiwicXVlcnlzdHJpbmciLCJIdHRwQ2xpZW50IiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwiY3JlZGVudGlhbHMiLCJob3N0IiwicG9ydCIsImhlYWRlcnMiLCJBY2NlcHQiLCJsb2dnZXIiLCJ0aW1lb3V0IiwicmVxdWVzdExpYiIsInVzZXJBZ2VudCIsImVuZHBvaW50IiwibWV0aG9kIiwiY2FsbGJhY2siLCJza2lwSnNvblBhcnNpbmciLCJjdXN0b21SZXNwb25zZVBhcnNlciIsInBhdGgiLCJPYmplY3QiLCJhc3NpZ24iLCJ1bmRlZmluZWQiLCJrZXlzIiwiZm9yRWFjaCIsImtleSIsInNpZ25hdHVyZVNlY3JldCIsInNpZ25hdHVyZU1ldGhvZCIsInNwbGl0UGF0aCIsInNwbGl0IiwicGFyYW1zIiwiZGVjb2RlIiwidGltZXN0YW1wIiwiRGF0ZSIsImdldFRpbWUiLCJ0b1N0cmluZyIsImFwaV9zZWNyZXQiLCJoYXNoIiwiZ2VuZXJhdGVTaWduYXR1cmUiLCJxdWVyeSIsInNvcnQiLCJlbmNvZGVVUkkiLCJyZXBsYWNlIiwiaW5mbyIsImJvZHkiLCJlbmQiLCJyZXNwb25zZURhdGEiLCJvbiIsInJlc3BvbnNlIiwiaXNCaW5hcnkiLCJzZXRFbmNvZGluZyIsImNodW5rIiwicHVzaCIsInN0YXR1c0NvZGUiLCJCdWZmZXIiLCJjb25jYXQiLCJfX3BhcnNlUmVzcG9uc2UiLCJlIiwiZXJyb3IiLCJodHRwUmVzcG9uc2UiLCJkYXRhIiwiaXNBcnJheU9yQnVmZmVyIiwiQXJyYXkiLCJFcnJvciIsInN0YXR1cyIsIm1lc3NhZ2UiLCJyZXRyeUFmdGVyTWlsbGlzIiwiam9pbiIsIkpTT04iLCJwYXJzZSIsInBhcnNlRXJyb3IiLCJfYWRkTGltaXRlZEFjY2Vzc01lc3NhZ2VUb0Vycm9ycyIsImxpbWl0ZWRBY2Nlc3NTdGF0dXMiLCJlcnIiLCJfSU5GT18iLCJnZXQiLCJ1c2VKd3QiLCJ1c2VCYXNpY0F1dGgiLCJhcGlLZXkiLCJhcGlTZWNyZXQiLCJzdHJpbmdpZnkiLCJnZW5lcmF0ZUp3dCIsImZyb20iLCJkZWxldGUiLCJwb3N0RmlsZSIsInFzIiwibGVuZ3RoIiwiam9pbkNoYXIiLCJpbmRleE9mIiwiZmlsZSIsImZvcm1EYXRhIiwidmFsdWUiLCJmaWxlbmFtZSIsInVybCIsInBvc3QiLCJBdXRob3JpemF0aW9uIiwicG9zdEpzb24iLCJwb3N0VXNlUXVlcnlTdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxJQUFJQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQyxPQUFELENBQW5COztBQUNBLElBQUlDLElBQUksR0FBR0QsT0FBTyxDQUFDLE1BQUQsQ0FBbEI7O0FBQ0EsSUFBSUUsT0FBTyxHQUFHRixPQUFPLENBQUMsU0FBRCxDQUFyQjs7QUFDQSxJQUFJRyxXQUFXLEdBQUdILE9BQU8sQ0FBQyxhQUFELENBQXpCOztBQUVBLE1BQU1JLFVBQU4sQ0FBaUI7QUFDZkMsRUFBQUEsV0FBVyxDQUFDQyxPQUFELEVBQVVDLFdBQVYsRUFBdUI7QUFDaEMsU0FBS0EsV0FBTCxHQUFtQkEsV0FBbkI7QUFDQSxTQUFLQyxJQUFMLEdBQVlGLE9BQU8sQ0FBQ0UsSUFBUixJQUFnQixnQkFBNUI7QUFDQSxTQUFLQyxJQUFMLEdBQVlILE9BQU8sQ0FBQ0csSUFBUixJQUFnQixHQUE1QjtBQUNBLFNBQUtWLEtBQUwsR0FBYU8sT0FBTyxDQUFDUCxLQUFSLElBQWlCQSxLQUE5QjtBQUNBLFNBQUtFLElBQUwsR0FBWUssT0FBTyxDQUFDTCxJQUFSLElBQWdCQSxJQUE1QjtBQUNBLFNBQUtTLE9BQUwsR0FBZTtBQUNiLHNCQUFnQixtQ0FESDtBQUViQyxNQUFBQSxNQUFNLEVBQUU7QUFGSyxLQUFmO0FBSUEsU0FBS0MsTUFBTCxHQUFjTixPQUFPLENBQUNNLE1BQXRCO0FBQ0EsU0FBS0MsT0FBTCxHQUFlUCxPQUFPLENBQUNPLE9BQXZCO0FBQ0EsU0FB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QUFQLEdBQWFsQixXQUFXLENBQUMrRSxTQUFaLENBQXNCbEQsTUFBdEIsQ0FBcEI7QUFFQSxTQUFLOUIsT0FBTCxDQUNFO0FBQ0VtQixNQUFBQSxJQUFJLEVBQUVBO0FBRFIsS0FERixFQUlFLE1BSkYsRUFLRUgsUUFMRjtBQU9EOztBQXJiYzs7ZUF3YkZkLFUiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgaHR0cHMgPSByZXF1aXJlKFwiaHR0cHNcIik7XG52YXIgaHR0cCA9IHJlcXVpcmUoXCJodHRwXCIpO1xudmFyIHJlcXVlc3QgPSByZXF1aXJlKFwicmVxdWVzdFwiKTtcbnZhciBxdWVyeXN0cmluZyA9IHJlcXVpcmUoXCJxdWVyeXN0cmluZ1wiKTtcblxuY2xhc3MgSHR0cENsaWVudCB7XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMsIGNyZWRlbnRpYWxzKSB7XG4gICAgdGhpcy5jcmVkZW50aWFscyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMuaG9zdCA9IG9wdGlvbnMuaG9zdCB8fCBcInJlc3QubmV4bW8uY29tXCI7XG4gICAgdGhpcy5wb3J0ID0gb3B0aW9ucy5wb3J0IHx8IDQ0MztcbiAgICB0aGlzLmh0dHBzID0gb3B0aW9ucy5odHRwcyB8fCBodHRwcztcbiAgICB0aGlzLmh0dHAgPSBvcHRpb25zLmh0dHAgfHwgaHR0cDtcbiAgICB0aGlzLmhlYWRlcnMgPSB7XG4gICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZFwiLFxuICAgICAgQWNjZXB0OiBcImFwcGxpY2F0aW9uL2pzb25cIlxuICAgIH07XG4gICAgdGhpcy5sb2dnZXIgPSBvcHRpb25zLmxvZ2dlcjtcbiAgICB0aGlzLnRpbWVvdXQgPSBvcHRpb25zLnRpbWVvdXQ7XG4gICAgdGhpcy5yZXF1ZXN0TGliID0gcmVxdWVzdDtcblxuICAgIGlmIChvcHRpb25zLnVzZXJBZ2VudCkge1xuICAgICAgdGhpcy5oZWFkZXJzW1wiVXNlci1BZ2VudFwiXSA9IG9wdGlvbnMudXNlckFnZW50O1xuICAgIH1cbiAgfVxuXG4gIHJlcXVlc3QoXG4gICAgZW5kcG9pbnQsXG4gICAgbWV0aG9kLFxuICAgIGNhbGxiYWNrLFxuICAgIHNraXBKc29uUGFyc2luZyA9IGZhbHNlLFxuICAgIGN1c3RvbVJlc3BvbnNlUGFyc2VyXG4gICkge1xuICAgIGlmICh0eXBlb2YgbWV0aG9kID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGNhbGxiYWNrID0gbWV0aG9kO1xuICAgICAgZW5kcG9pbnQubWV0aG9kID0gZW5kcG9pbnQubWV0aG9kIHx8IFwiR0VUXCI7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgbWV0aG9kICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBlbmRwb2ludC5tZXRob2QgPSBtZXRob2Q7XG4gICAgfVxuXG4gICAgaWYgKGVuZHBvaW50Lm1ldGhvZCA9PT0gXCJQT1NUXCIgfHwgZW5kcG9pbnQubWV0aG9kID09PSBcIkRFTEVURVwiKSB7XG4gICAgICAvLyBUT0RPOiB2ZXJpZnkgdGhlIGZvbGxvd2luZyBmaXggaXMgcmVxdWlyZWRcbiAgICAgIC8vIEZpeCBicm9rZW4gZHVlIG90IDQxMSBDb250ZW50LUxlbmd0aCBlcnJvciBub3cgc2VudCBieSBWb25hZ2UgQVBJXG4gICAgICAvLyBQTCAyMDE2LVNlcHQtNiAtIGNvbW1lbnRlZCBvdXQgQ29udGVudC1MZW5ndGggMFxuICAgICAgLy8gaGVhZGVyc1snQ29udGVudC1MZW5ndGgnXSA9IDA7XG4gICAgfVxuICAgIHZhciBvcHRpb25zID0ge1xuICAgICAgaG9zdDogZW5kcG9pbnQuaG9zdCA/IGVuZHBvaW50Lmhvc3QgOiB0aGlzLmhvc3QsXG4gICAgICBwb3J0OiB0aGlzLnBvcnQsXG4gICAgICBwYXRoOiBlbmRwb2ludC5wYXRoLFxuICAgICAgbWV0aG9kOiBlbmRwb2ludC5tZXRob2QsXG4gICAgICBoZWFkZXJzOiBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmhlYWRlcnMpXG4gICAgfTtcblxuICAgIGlmICh0aGlzLnRpbWVvdXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgb3B0aW9ucy50aW1lb3V0ID0gdGhpcy50aW1lb3V0O1xuICAgIH1cblxuICAgIC8vIEFsbG93IGV4aXN0aW5nIGhlYWRlcnMgdG8gYmUgb3ZlcnJpZGRlblxuICAgIC8vIEFsbG93IG5ldyBoZWFkZXJzIHRvIGJlIGFkZGVkXG4gICAgaWYgKGVuZHBvaW50LmhlYWRlcnMpIHtcbiAgICAgIE9iamVjdC5rZXlzKGVuZHBvaW50LmhlYWRlcnMpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7XG4gICAgICAgIG9wdGlvbnMuaGVhZGVyc1trZXldID0gZW5kcG9pbnQuaGVhZGVyc1trZXldO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY3JlZGVudGlhbHMuc2lnbmF0dXJlU2VjcmV0ICYmIHRoaXMuY3JlZGVudGlhbHMuc2lnbmF0dXJlTWV0aG9kKSB7XG4gICAgICBjb25zdCBzcGxpdFBhdGggPSBvcHRpb25zLnBhdGguc3BsaXQoL1xcPyguKykvKTtcbiAgICAgIGNvbnN0IHBhdGggPSBzcGxpdFBhdGhbMF07XG5cbiAgICAgIHZhciBwYXJhbXMgPSBxdWVyeXN0cmluZy5kZWNvZGUoc3BsaXRQYXRoWzFdKTtcblxuICAgICAgLy8gYWRkIHRpbWVzdGFtcCBpZiBub3QgYWxyZWFkeSBwcmVzZW50XG4gICAgICBpZiAoIXBhcmFtcy50aW1lc3RhbXApIHtcbiAgICAgICAgcGFyYW1zLnRpbWVzdGFtcCA9IChuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwMDApIHwgMDsgLy8gZmxvb3IgdG8gc2Vjb25kc1xuICAgICAgICBwYXJhbXMudGltZXN0YW1wID0gcGFyYW1zLnRpbWVzdGFtcC50b1N0cmluZygpO1xuICAgICAgfVxuXG4gICAgICAvLyBzdHJpcCBBUEkgU2VjcmV0XG4gICAgICBkZWxldGUgcGFyYW1zLmFwaV9zZWNyZXQ7XG5cbiAgICAgIGNvbnN0IGhhc2ggPSB0aGlzLmNyZWRlbnRpYWxzLmdlbmVyYXRlU2lnbmF0dXJlKHBhcmFtcyk7XG5cbiAgICAgIHZhciBxdWVyeSA9IFwiXCI7XG5cbiAgICAgIC8vIHJlYnVpbGQgcXVlcnlcbiAgICAgIE9iamVjdC5rZXlzKHBhcmFtcylcbiAgICAgICAgLnNvcnQoKVxuICAgICAgICAuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgIHF1ZXJ5ICs9IFwiJlwiICsga2V5ICsgXCI9XCIgKyBlbmNvZGVVUkkocGFyYW1zW2tleV0pO1xuICAgICAgICB9KTtcblxuICAgICAgLy8gcmVwbGFjZSB0aGUgZmlyc3QgJiB3aXRoID9cbiAgICAgIHF1ZXJ5ID0gcXVlcnkucmVwbGFjZSgvJi9pLCBcIj9cIik7XG5cbiAgICAgIG9wdGlvbnMucGF0aCA9IGAke3BhdGh9JHtxdWVyeX0mc2lnPSR7aGFzaH1gO1xuICAgIH1cblxuICAgIHRoaXMubG9nZ2VyLmluZm8oXCJSZXF1ZXN0OlwiLCBvcHRpb25zLCBcIlxcbkJvZHk6XCIsIGVuZHBvaW50LmJvZHkpO1xuICAgIHZhciByZXF1ZXN0O1xuXG4gICAgaWYgKG9wdGlvbnMucG9ydCA9PT0gNDQzKSB7XG4gICAgICByZXF1ZXN0ID0gdGhpcy5odHRwcy5yZXF1ZXN0KG9wdGlvbnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXF1ZXN0ID0gdGhpcy5odHRwLnJlcXVlc3Qob3B0aW9ucyk7XG4gICAgfVxuXG4gICAgcmVxdWVzdC5lbmQoZW5kcG9pbnQuYm9keSk7XG5cbiAgICAvLyBLZWVwIGFuIGFycmF5IG9mIFN0cmluZyBvciBCdWZmZXJzLFxuICAgIC8vIGRlcGVuZGluZyBvbiBjb250ZW50IHR5cGUgKGJpbmFyeSBvciBKU09OKSBvZiByZXNwb25zZVxuICAgIHZhciByZXNwb25zZURhdGEgPSBbXTtcblxuICAgIHJlcXVlc3Qub24oXCJyZXNwb25zZVwiLCByZXNwb25zZSA9PiB7XG4gICAgICB2YXIgaXNCaW5hcnkgPVxuICAgICAgICByZXNwb25zZS5oZWFkZXJzW1wiY29udGVudC10eXBlXCJdID09PSBcImFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbVwiO1xuICAgICAgaWYgKCFpc0JpbmFyeSkge1xuICAgICAgICByZXNwb25zZS5zZXRFbmNvZGluZyhcInV0ZjhcIik7XG4gICAgICB9XG5cbiAgICAgIHJlc3BvbnNlLm9uKFwiZGF0YVwiLCBjaHVuayA9PiB7XG4gICAgICAgIHJlc3BvbnNlRGF0YS5wdXNoKGNodW5rKTtcbiAgICAgIH0pO1xuXG4gICAgICByZXNwb25zZS5vbihcImVuZFwiLCAoKSA9PiB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmluZm8oXCJyZXNwb25zZSBlbmRlZDpcIiwgcmVzcG9uc2Uuc3RhdHVzQ29kZSk7XG4gICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgIGlmIChpc0JpbmFyeSkge1xuICAgICAgICAgICAgcmVzcG9uc2VEYXRhID0gQnVmZmVyLmNvbmNhdChyZXNwb25zZURhdGEpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRoaXMuX19wYXJzZVJlc3BvbnNlKFxuICAgICAgICAgICAgcmVzcG9uc2UsXG4gICAgICAgICAgICByZXNwb25zZURhdGEsXG4gICAgICAgICAgICBlbmRwb2ludC5tZXRob2QsXG4gICAgICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgICAgIHNraXBKc29uUGFyc2luZyxcbiAgICAgICAgICAgIGN1c3RvbVJlc3BvbnNlUGFyc2VyXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXNwb25zZS5vbihcImNsb3NlXCIsIGUgPT4ge1xuICAgICAgICBpZiAoZSkge1xuICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgICAgXCJwcm9ibGVtIHdpdGggQVBJIHJlcXVlc3QgZGV0YWlsZWQgc3RhY2t0cmFjZSBiZWxvdyBcIlxuICAgICAgICAgICk7XG4gICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoZSk7XG4gICAgICAgICAgY2FsbGJhY2soZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJlcXVlc3Qub24oXCJlcnJvclwiLCBlID0+IHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFwicHJvYmxlbSB3aXRoIEFQSSByZXF1ZXN0IGRldGFpbGVkIHN0YWNrdHJhY2UgYmVsb3cgXCIpO1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoZSk7XG4gICAgICBjYWxsYmFjayhlKTtcbiAgICB9KTtcbiAgfVxuXG4gIF9fcGFyc2VSZXNwb25zZShcbiAgICBodHRwUmVzcG9uc2UsXG4gICAgZGF0YSxcbiAgICBtZXRob2QsXG4gICAgY2FsbGJhY2ssXG4gICAgc2tpcEpzb25QYXJzaW5nLFxuICAgIGN1c3RvbVJlc3BvbnNlUGFyc2VyXG4gICkge1xuICAgIGNvbnN0IGlzQXJyYXlPckJ1ZmZlciA9IGRhdGEgaW5zdGFuY2VvZiBBcnJheSB8fCBkYXRhIGluc3RhbmNlb2YgQnVmZmVyO1xuICAgIGlmICghaXNBcnJheU9yQnVmZmVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJkYXRhIHNob3VsZCBiZSBvZiB0eXBlIEFycmF5IG9yIEJ1ZmZlclwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdGF0dXMgPSBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTtcbiAgICBjb25zdCBoZWFkZXJzID0gaHR0cFJlc3BvbnNlLmhlYWRlcnM7XG5cbiAgICBsZXQgcmVzcG9uc2UgPSBudWxsO1xuICAgIHZhciBlcnJvciA9IG51bGw7XG5cbiAgICB0cnkge1xuICAgICAgaWYgKHN0YXR1cyA+PSA1MDApIHtcbiAgICAgICAgZXJyb3IgPSB7XG4gICAgICAgICAgbWVzc2FnZTogXCJTZXJ2ZXIgRXJyb3JcIixcbiAgICAgICAgICBzdGF0dXNDb2RlOiBzdGF0dXNcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgIGh0dHBSZXNwb25zZS5oZWFkZXJzW1wiY29udGVudC10eXBlXCJdID09PSBcImFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbVwiXG4gICAgICApIHtcbiAgICAgICAgcmVzcG9uc2UgPSBkYXRhO1xuICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IDQyOSkge1xuICAgICAgICAvLyA0MjkgZG9lcyBub3QgcmV0dXJuIGEgcGFyc2FibGUgYm9keVxuICAgICAgICBpZiAoIWhlYWRlcnNbXCJyZXRyeS1hZnRlclwiXSkge1xuICAgICAgICAgIC8vIHJldHJ5IGJhc2VkIG9uIGFsbG93ZWQgcGVyIHNlY29uZFxuICAgICAgICAgIGNvbnN0IHJldHJ5QWZ0ZXJNaWxsaXMgPSBtZXRob2QgPT09IFwiUE9TVFwiID8gMTAwMCAvIDIgOiAxMDAwIC8gNTtcbiAgICAgICAgICBoZWFkZXJzW1wicmV0cnktYWZ0ZXJcIl0gPSByZXRyeUFmdGVyTWlsbGlzO1xuICAgICAgICB9XG4gICAgICAgIGVycm9yID0ge1xuICAgICAgICAgIGJvZHk6IGRhdGEuam9pbihcIlwiKVxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IDIwNCkge1xuICAgICAgICByZXNwb25zZSA9IG51bGw7XG4gICAgICB9IGVsc2UgaWYgKHN0YXR1cyA+PSA0MDAgfHwgc3RhdHVzIDwgMjAwKSB7XG4gICAgICAgIGVycm9yID0ge1xuICAgICAgICAgIGJvZHk6IEpTT04ucGFyc2UoZGF0YS5qb2luKFwiXCIpKSxcbiAgICAgICAgICBoZWFkZXJzXG4gICAgICAgIH07XG4gICAgICB9IGVsc2UgaWYgKG1ldGhvZCAhPT0gXCJERUxFVEVcIikge1xuICAgICAgICBpZiAoISFza2lwSnNvblBhcnNpbmcpIHtcbiAgICAgICAgICByZXNwb25zZSA9IGRhdGEuam9pbihcIlwiKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNwb25zZSA9IEpTT04ucGFyc2UoZGF0YS5qb2luKFwiXCIpKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzcG9uc2UgPSBkYXRhO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKHBhcnNlRXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKHBhcnNlRXJyb3IpO1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIFwiY291bGQgbm90IGNvbnZlcnQgQVBJIHJlc3BvbnNlIHRvIEpTT04sIGFib3ZlIGVycm9yIGlzIGlnbm9yZWQgYW5kIHJhdyBBUEkgcmVzcG9uc2UgaXMgcmV0dXJuZWQgdG8gY2xpZW50XCJcbiAgICAgICk7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcIlJhdyBFcnJvciBtZXNzYWdlIGZyb20gQVBJIFwiKTtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBcIiR7ZGF0YX1cImApO1xuXG4gICAgICBlcnJvciA9IHtcbiAgICAgICAgc3RhdHVzOiBzdGF0dXMsXG4gICAgICAgIG1lc3NhZ2U6IFwiVGhlIEFQSSByZXNwb25zZSBjb3VsZCBub3QgYmUgcGFyc2VkLlwiLFxuICAgICAgICBib2R5OiBkYXRhLmpvaW4oXCJcIiksXG4gICAgICAgIHBhcnNlRXJyb3I6IHBhcnNlRXJyb3JcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKGVycm9yKSB7XG4gICAgICBlcnJvci5zdGF0dXNDb2RlID0gc3RhdHVzO1xuICAgICAgZXJyb3IuaGVhZGVycyA9IGhlYWRlcnM7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBpZiAodHlwZW9mIGN1c3RvbVJlc3BvbnNlUGFyc2VyID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgLy8gZG9uJ3QgdHJ5IHRvIHBhcnNlIHRoZSByZXNwb25zZSBvbiBlcnJvcnNcbiAgICAgICAgaWYgKHJlc3BvbnNlKSB7XG4gICAgICAgICAgcmVzcG9uc2UgPSBjdXN0b21SZXNwb25zZVBhcnNlcihyZXNwb25zZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNhbGxiYWNrKGVycm9yLCByZXNwb25zZSk7XG4gICAgfVxuICB9XG5cbiAgX2FkZExpbWl0ZWRBY2Nlc3NNZXNzYWdlVG9FcnJvcnMoY2FsbGJhY2ssIGxpbWl0ZWRBY2Nlc3NTdGF0dXMpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24oZXJyLCBkYXRhKSB7XG4gICAgICBpZiAoZXJyICYmIGVyci5zdGF0dXMgPT0gbGltaXRlZEFjY2Vzc1N0YXR1cykge1xuICAgICAgICBlcnIuX0lORk9fID1cbiAgICAgICAgICBcIlRoaXMgZW5kcG9pbnQgbWF5IG5lZWQgYWN0aXZhdGluZyBvbiB5b3VyIGFjY291bnQuIFBsZWFzZSBlbWFpbCBzdXBwb3J0QG5leG1vLmNvbSBmb3IgbW9yZSBpbmZvcm1hdGlvblwiO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gY2FsbGJhY2soZXJyLCBkYXRhKTtcbiAgICB9O1xuICB9XG5cbiAgZ2V0KHBhdGgsIHBhcmFtcywgY2FsbGJhY2ssIHVzZUp3dCA9IGZhbHNlLCB1c2VCYXNpY0F1dGggPSBmYWxzZSkge1xuICAgIGlmICghY2FsbGJhY2spIHtcbiAgICAgIGlmICh0eXBlb2YgcGFyYW1zID09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBjYWxsYmFjayA9IHBhcmFtcztcbiAgICAgICAgcGFyYW1zID0ge307XG4gICAgICB9XG4gICAgfVxuXG4gICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xuICAgIGlmICghdXNlSnd0ICYmICF1c2VCYXNpY0F1dGgpIHtcbiAgICAgIHBhcmFtc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleTtcbiAgICAgIHBhcmFtc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldDtcbiAgICB9XG5cbiAgICBwYXRoID0gcGF0aCArIFwiP1wiICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHBhcmFtcyk7XG5cbiAgICBjb25zdCBoZWFkZXJzID0ge1xuICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCJcbiAgICB9O1xuICAgIGlmICh1c2VKd3QpIHtcbiAgICAgIGhlYWRlcnNbXCJBdXRob3JpemF0aW9uXCJdID0gYEJlYXJlciAke3RoaXMuY3JlZGVudGlhbHMuZ2VuZXJhdGVKd3QoKX1gO1xuICAgIH1cbiAgICBpZiAodXNlQmFzaWNBdXRoKSB7XG4gICAgICBoZWFkZXJzW1wiQXV0aG9yaXphdGlvblwiXSA9IGBCYXNpYyAke0J1ZmZlci5mcm9tKFxuICAgICAgICB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleSArIFwiOlwiICsgdGhpcy5jcmVkZW50aWFscy5hcGlTZWNyZXRcbiAgICAgICkudG9TdHJpbmcoXCJiYXNlNjRcIil9YDtcbiAgICB9XG5cbiAgICB0aGlzLnJlcXVlc3QoXG4gICAgICB7XG4gICAgICAgIHBhdGg6IHBhdGgsXG4gICAgICAgIGhlYWRlcnNcbiAgICAgIH0sXG4gICAgICBcIkdFVFwiLFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgZGVsZXRlKHBhdGgsIGNhbGxiYWNrLCB1c2VKd3QsIHVzZUJhc2ljQXV0aCkge1xuICAgIGxldCBwYXJhbXMgPSB7fTtcbiAgICBpZiAoIXVzZUp3dCAmJiAhdXNlQmFzaWNBdXRoKSB7XG4gICAgICBwYXJhbXNbXCJhcGlfa2V5XCJdID0gdGhpcy5jcmVkZW50aWFscy5hcGlLZXk7XG4gICAgICBwYXJhbXNbXCJhcGlfc2VjcmV0XCJdID0gdGhpcy5jcmVkZW50aWFscy5hcGlTZWNyZXQ7XG4gICAgfVxuXG4gICAgbGV0IGhlYWRlcnMgPSB7fTtcblxuICAgIGlmICh1c2VCYXNpY0F1dGgpIHtcbiAgICAgIGhlYWRlcnNbXCJBdXRob3JpemF0aW9uXCJdID0gYEJhc2ljICR7QnVmZmVyLmZyb20oXG4gICAgICAgIHRoaXMuY3JlZGVudGlhbHMuYXBpS2V5ICsgXCI6XCIgKyB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldFxuICAgICAgKS50b1N0cmluZyhcImJhc2U2NFwiKX1gO1xuICAgIH1cbiAgICBwYXRoID0gcGF0aCArIFwiP1wiICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHBhcmFtcyk7XG5cbiAgICB0aGlzLnJlcXVlc3QoXG4gICAgICB7XG4gICAgICAgIHBhdGg6IHBhdGgsXG4gICAgICAgIGhlYWRlcnNcbiAgICAgIH0sXG4gICAgICBcIkRFTEVURVwiLFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgcG9zdEZpbGUocGF0aCwgb3B0aW9ucywgY2FsbGJhY2ssIHVzZUp3dCkge1xuICAgIGxldCBxcyA9IHt9O1xuICAgIGlmICghdXNlSnd0KSB7XG4gICAgICBxc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleTtcbiAgICAgIHFzW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0O1xuICAgIH1cblxuICAgIGlmIChPYmplY3Qua2V5cyhxcykubGVuZ3RoKSB7XG4gICAgICBsZXQgam9pbkNoYXIgPSBcIj9cIjtcbiAgICAgIGlmIChwYXRoLmluZGV4T2Yoam9pbkNoYXIpICE9PSAtMSkge1xuICAgICAgICBqb2luQ2hhciA9IFwiJlwiO1xuICAgICAgfVxuICAgICAgcGF0aCA9IHBhdGggKyBqb2luQ2hhciArIHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeShxcyk7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZSA9IG9wdGlvbnMuZmlsZTtcbiAgICBkZWxldGUgb3B0aW9ucy5maWxlOyAvLyBXZSBkb24ndCBzZW5kIHRoaXMgYXMgbWV0YWRhdGFcblxuICAgIGNvbnN0IGZvcm1EYXRhID0ge307XG5cbiAgICBpZiAoZmlsZSkge1xuICAgICAgZm9ybURhdGFbXCJmaWxlZGF0YVwiXSA9IHtcbiAgICAgICAgdmFsdWU6IGZpbGUsXG4gICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICBmaWxlbmFtZTogb3B0aW9ucy5maWxlbmFtZSB8fCBudWxsXG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbnMuaW5mbykge1xuICAgICAgZm9ybURhdGEuaW5mbyA9IEpTT04uc3RyaW5naWZ5KG9wdGlvbnMuaW5mbyk7XG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbnMudXJsKSB7XG4gICAgICBmb3JtRGF0YS51cmwgPSBvcHRpb25zLnVybDtcbiAgICB9XG5cbiAgICB0aGlzLnJlcXVlc3RMaWIucG9zdChcbiAgICAgIHtcbiAgICAgICAgdXJsOiBcImh0dHBzOi8vXCIgKyB0aGlzLmhvc3QgKyBwYXRoLFxuICAgICAgICBmb3JtRGF0YTogZm9ybURhdGEsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy5jcmVkZW50aWFscy5nZW5lcmF0ZUp3dCgpfWBcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIGNhbGxiYWNrXG4gICAgKTtcbiAgfVxuXG4gIHBvc3QocGF0aCwgcGFyYW1zLCBjYWxsYmFjaywgdXNlSnd0KSB7XG4gICAgbGV0IHFzID0ge307XG4gICAgaWYgKCF1c2VKd3QpIHtcbiAgICAgIHFzW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpS2V5O1xuICAgICAgcXNbXCJhcGlfc2VjcmV0XCJdID0gdGhpcy5jcmVkZW50aWFscy5hcGlTZWNyZXQ7XG4gICAgfVxuXG4gICAgbGV0IGpvaW5DaGFyID0gXCI/XCI7XG4gICAgaWYgKHBhdGguaW5kZXhPZihqb2luQ2hhcikgIT09IC0xKSB7XG4gICAgICBqb2luQ2hhciA9IFwiJlwiO1xuICAgIH1cblxuICAgIHBhdGggPSBwYXRoICsgam9pbkNoYXIgKyBxdWVyeXN0cmluZy5zdHJpbmdpZnkocXMpO1xuXG4gICAgdGhpcy5yZXF1ZXN0KFxuICAgICAge1xuICAgICAgICBwYXRoOiBwYXRoLFxuICAgICAgICBib2R5OiBxdWVyeXN0cmluZy5zdHJpbmdpZnkocGFyYW1zKVxuICAgICAgfSxcbiAgICAgIFwiUE9TVFwiLFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgcG9zdEpzb24ocGF0aCwgcGFyYW1zLCBjYWxsYmFjaywgdXNlSnd0LCB1c2VCYXNpY0F1dGgpIHtcbiAgICBsZXQgcXMgPSB7fTtcbiAgICBpZiAoIXVzZUp3dCAmJiAhdXNlQmFzaWNBdXRoKSB7XG4gICAgICBxc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleTtcbiAgICAgIHFzW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0O1xuICAgIH1cblxuICAgIGxldCBqb2luQ2hhciA9IFwiP1wiO1xuICAgIGlmIChwYXRoLmluZGV4T2Yoam9pbkNoYXIpICE9PSAtMSkge1xuICAgICAgam9pbkNoYXIgPSBcIiZcIjtcbiAgICB9XG5cbiAgICBwYXRoID0gcGF0aCArIGpvaW5DaGFyICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHFzKTtcblxuICAgIGxldCBoZWFkZXJzID0ge1xuICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCJcbiAgICB9O1xuICAgIGlmICh1c2VCYXNpY0F1dGgpIHtcbiAgICAgIGhlYWRlcnNbXCJBdXRob3JpemF0aW9uXCJdID0gYEJhc2ljICR7QnVmZmVyLmZyb20oXG4gICAgICAgIHRoaXMuY3JlZGVudGlhbHMuYXBpS2V5ICsgXCI6XCIgKyB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldFxuICAgICAgKS50b1N0cmluZyhcImJhc2U2NFwiKX1gO1xuICAgIH1cblxuICAgIHRoaXMucmVxdWVzdChcbiAgICAgIHtcbiAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocGFyYW1zKSxcbiAgICAgICAgaGVhZGVyc1xuICAgICAgfSxcbiAgICAgIFwiUE9TVFwiLFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgcG9zdFVzZVF1ZXJ5U3RyaW5nKHBhdGgsIHBhcmFtcywgY2FsbGJhY2ssIHVzZUp3dCkge1xuICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcbiAgICBpZiAoIXVzZUp3dCkge1xuICAgICAgcGFyYW1zW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpS2V5O1xuICAgICAgcGFyYW1zW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0O1xuICAgIH1cblxuICAgIHBhdGggPSBwYXRoICsgXCI/XCIgKyBxdWVyeXN0cmluZy5zdHJpbmdpZnkocGFyYW1zKTtcblxuICAgIHRoaXMucmVxdWVzdChcbiAgICAgIHtcbiAgICAgICAgcGF0aDogcGF0aFxuICAgICAgfSxcbiAgICAgIFwiUE9TVFwiLFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEh0dHBDbGllbnQ7XG4iXX0=